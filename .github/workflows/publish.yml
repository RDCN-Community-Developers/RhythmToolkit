name: Publish NuGet (manual)

on:
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Optional version suffix (e.g. -beta1)'
        required: false
        default: ''
  repository_dispatch:
    types: [ publish ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Build & Pack
        run: |
          VER=$(grep -oP '<Version>\K[^<]+' RhythmBase/RhythmBase.csproj)
          SUFFIX="${{ github.event.inputs.version_suffix || github.event.client_payload.version_suffix }}"
          VER="${VER}${SUFFIX}"
          dotnet build RhythmBase/RhythmBase.csproj -c Release \
            -o ./pkg \
            /p:Version="$VER"

      - name: Push to NuGet.org
        run: |
          dotnet nuget push ./pkg/*.nupkg \
            --source https://api.nuget.org/v3/index.json \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate